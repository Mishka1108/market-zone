<div class="dashboard-container">
  <header class="dashboard-header">
    <h1>рЃърЃарЃЮрЃцрЃўрЃџрЃўрЃА рЃњрЃЋрЃћрЃарЃЊрЃў</h1>
  </header>
  <div class="card-header">
    <h2>рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃџрЃўрЃА рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ</h2>
  </div>
</div>

<div class="profile">
  <!-- рЃърЃўрЃарЃЋрЃћрЃџрЃў рЃЎрЃЮрЃЏрЃърЃЮрЃюрЃћрЃюрЃбрЃў -->
  <div class="profile-information">
    <div class="image-upload-container">
      <!-- рЃњрЃљрЃЏрЃЮрЃАрЃгрЃЮрЃарЃћрЃЉрЃБрЃџрЃў рЃърЃарЃЮрЃцрЃўрЃџрЃўрЃА рЃАрЃБрЃарЃљрЃЌрЃўрЃА input рЃДрЃЋрЃћрЃџрЃљ рЃЉрЃарЃљрЃБрЃќрЃћрЃарЃўрЃАрЃЌрЃЋрЃўрЃА -->
      <input 
        type="file" 
        id="profileImageInput" 
        accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
        capture="environment"
        style="position: absolute; left: -9999px; opacity: 0; width: 1px; height: 1px; overflow: hidden;"
        (change)="onFileSelected($event, 'profile')"
        #profileInput
        tabindex="-1"
      />
    
      <!-- рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў hidden input рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА -->
      <input 
        type="file" 
        id="profileImageInputAlt" 
        accept="image/*" 
        style="display: none;"
        (change)="onAlternativeFileSelected($event, 'profile')"
      />

      <img 
        [src]="currentUser?.profileImage || 'https://i.ibb.co/GvshXkLK/307ce493-b254-4b2d-8ba4-d12c080d6651.jpg'" 
        id="profileImagePreview" 
        class="profileimg" 
        alt="Profile Image"
        (click)="triggerFileInput()"
        style="cursor: pointer;"
      />

      <!-- рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃдрЃўрЃџрЃљрЃЎрЃў -->
      <label for="profileImageInputAlt" class="android-upload-btn" 
             style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
        ­ЪЊи рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃцрЃЮрЃбрЃЮ
      </label>

      <button class="btn" mat-flat-button (click)="logout()">рЃњрЃљрЃАрЃЋрЃџрЃљ</button>
    </div>
    
    <div class="user-info" *ngIf="currentUser">
      <div class="username">
        <span class="name">{{currentUser.name}}</span>
        <span class="name">{{currentUser.secondName}}</span>
      </div>
      <div>
        <p>рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃў: {{currentUser.phone}}</p>
        <p>рЃћрЃџрЃцрЃЮрЃАрЃбрЃљ: {{currentUser.email}}</p>
        <p>рЃърЃўрЃарЃљрЃЊрЃў рЃюрЃЮрЃЏрЃћрЃарЃў: {{currentUser.personalNumber}}</p>
      </div>
      <div class="user-actions">
        <span class="pro">рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ:</span>
        <span class="num">{{userProducts.length}} / {{MAX_PRODUCTS_ALLOWED}}</span>
        <p *ngIf="!canAddMoreProducts()" class="limit-warning">
          рЃЏрЃўрЃдрЃгрЃћрЃБрЃџрЃўрЃљ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃўрЃА рЃЏрЃљрЃЦрЃАрЃўрЃЏрЃљрЃџрЃБрЃарЃў рЃарЃљрЃЮрЃЊрЃћрЃюрЃЮрЃЉрЃљ!
        </p>
        <p *ngIf="canAddMoreProducts()" class="remaining-products">
          рЃЊрЃљрЃарЃЕрЃћрЃюрЃўрЃџрЃўрЃљ {{getRemainingProductsCount()}} рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ
        </p>
      </div>
      <div class="btndiv">
        <button mat-flat-button class="btn" (click)="toggleProductForm()" [disabled]="!canAddMoreProducts() && !productFormVisible">
          {{ productFormVisible ? 'рЃЊрЃљрЃ«рЃБрЃарЃЋрЃљ' : 'рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃў рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ' }}
        </button>
      </div>
    </div>
  </div>
</div>

<div class="conteiner">
  <div class="card3" *ngIf="productFormVisible">
    <h2>рЃерЃћрЃўрЃДрЃЋрЃљрЃюрЃћрЃЌ рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ</h2>
    
    <form [formGroup]="productForm" class="card4" (ngSubmit)="addProduct()">
      <mat-form-field class="example-full-width">
        <mat-label>рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў</mat-label>
        <input matInput formControlName="title">
        <mat-error *ngIf="productForm.controls.title.hasError('required')">
          рЃАрЃљрЃ«рЃћрЃџрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ</mat-label>
        <input type="text" matInput formControlName="category" [matAutocomplete]="auto">
        <mat-autocomplete #auto="matAutocomplete">
          <mat-option *ngFor="let category of filteredCategories" [value]="category">
            {{ category }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="productForm.controls.category.hasError('required')">
          рЃЎрЃљрЃбрЃћрЃњрЃЮрЃарЃўрЃљ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃњрЃљрЃЏрЃЮрЃерЃЋрЃћрЃЉрЃўрЃА рЃгрЃћрЃџрЃў</mat-label>
        <input matInput type="number" formControlName="year">
        <mat-error *ngIf="productForm.controls.year.hasError('required')">
          рЃгрЃћрЃџрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.year.hasError('min') || productForm.controls.year.hasError('max')">
          рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЌ рЃАрЃгрЃЮрЃарЃў рЃгрЃћрЃџрЃў (2000-рЃЊрЃљрЃю рЃЊрЃдрЃћрЃЏрЃЊрЃћ)
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃцрЃљрЃАрЃў</mat-label>
        <input matInput type="number" formControlName="price">
        <mat-error *ngIf="productForm.controls.price.hasError('required')">
          рЃцрЃљрЃАрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.price.hasError('min')">
          рЃцрЃљрЃАрЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА рЃЊрЃљрЃЊрЃћрЃЉрЃўрЃЌрЃў рЃарЃўрЃфрЃ«рЃЋрЃў
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў</mat-label>
        <input matInput type="tel" formControlName="phone">
        <mat-error *ngIf="productForm.controls.phone.hasError('required')">
          рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.phone.hasError('pattern')">
          рЃбрЃћрЃџрЃћрЃцрЃЮрЃюрЃўрЃА рЃюрЃЮрЃЏрЃћрЃарЃў рЃБрЃюрЃЊрЃљ рЃўрЃДрЃЮрЃА 9-рЃЊрЃљрЃю 15-рЃЏрЃЊрЃћ рЃфрЃўрЃцрЃарЃў
        </mat-error>
      </mat-form-field>

      <mat-form-field class="example-full-width">
        <mat-label>рЃўрЃЏрЃћрЃўрЃџрЃў</mat-label>
        <input matInput type="email" formControlName="email">
        <mat-error *ngIf="productForm.controls.email.hasError('required')">
          рЃўрЃЏрЃћрЃўрЃџрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
        <mat-error *ngIf="productForm.controls.email.hasError('email')">
          рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћрЃЌ рЃАрЃгрЃЮрЃарЃў рЃўрЃЏрЃћрЃўрЃџрЃў
        </mat-error>
      </mat-form-field>
      
      <mat-form-field class="example-full-width">
        <mat-label>рЃљрЃдрЃгрЃћрЃарЃљ</mat-label>
        <textarea matInput formControlName="description" rows="4"></textarea>
        <mat-error *ngIf="productForm.controls.description.hasError('required')">
          рЃљрЃдрЃгрЃћрЃарЃљ рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>

    <mat-form-field class="example-full-width">
        <mat-label>рЃЦрЃљрЃџрЃљрЃЦрЃў</mat-label>
        <input type="text" matInput formControlName="city" [matAutocomplete]="autoCity">
        <mat-autocomplete #autoCity="matAutocomplete">
          <mat-option *ngFor="let city of filteredCities" [value]="city">
            {{ city }}
          </mat-option>
        </mat-autocomplete>
        <mat-error *ngIf="productForm.controls['city'].hasError('required')">
          рЃЦрЃљрЃџрЃљрЃЦрЃў рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ
        </mat-error>
      </mat-form-field>
      <!-- рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃбрЃЋрЃўрЃарЃЌрЃЋрЃљ -->
      <div class="image-upload-section">
        <h3>рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃАрЃБрЃарЃљрЃЌрЃў</h3>
        
        <input 
          type="file" 
          id="productImageInput" 
          accept="image/*,image/jpeg,image/jpg,image/png,image/gif,image/webp" 
          capture="environment"
          class="imgupload"
          (change)="onFileSelected($event, 'product')"
          #productInput
          tabindex="-1"
        />

        <!-- рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў hidden input рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА -->
        <input 
          type="file" 
          id="productImageInputAlt" 
          accept="image/*" 
          class="imgupload"
          style="display: none; "
          (change)="onAlternativeFileSelected($event, 'product')"
        />

        <div class="image-upload-area" (click)="triggerProductImageInput()">
          <div *ngIf="!productImagePreview" class="upload-placeholder">
            <span class="upload-icon">­ЪЊи</span>
            <p>рЃЊрЃљрЃљрЃГрЃўрЃарЃћрЃЌ рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃАрЃљрЃарЃЕрЃћрЃЋрЃљрЃЊ</p>
          </div>
          <img *ngIf="productImagePreview" [src]="productImagePreview" class="product-image-preview" alt="Product Preview" />
        </div>

        <!-- рЃљрЃюрЃЊрЃарЃЮрЃўрЃЊрЃўрЃАрЃЌрЃЋрЃўрЃА рЃљрЃџрЃбрЃћрЃарЃюрЃљрЃбрЃўрЃБрЃџрЃў рЃдрЃўрЃџрЃљрЃЎрЃў -->
        <label for="productImageInputAlt" class="android-upload-btn" 
               style="display: inline-block; margin-top: 10px; padding: 8px 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px;">
          ­ЪЊи рЃљрЃџрЃб. рЃАрЃБрЃарЃљрЃЌрЃўрЃА рЃљрЃарЃЕрЃћрЃЋрЃљ
        </label>
      </div>

      <div class="form-actions">
        <button mat-flat-button type="submit" class="btn submit-btn" [disabled]="productForm.invalid || isUploading">
          <span *ngIf="!isUploading">рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃўрЃА рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃљ</span>
          <span *ngIf="isUploading">рЃўрЃбрЃЋрЃўрЃарЃЌрЃћрЃЉрЃљ...</span>
        </button>
        <button mat-flat-button type="button" class="btn cancel-btn" (click)="toggleProductForm()">
          рЃњрЃљрЃБрЃЦрЃЏрЃћрЃЉрЃљ
        </button>
      </div>
    </form>
  </div>
</div>

<h2 class="userproducts">рЃЕрЃћрЃЏрЃў рЃърЃарЃЮрЃЊрЃБрЃЦрЃбрЃћрЃЉрЃў</h2> 

<div class="user-products-section" *ngIf="userProducts.length > 0">
  
  <div class="products-grid">
    <div class="product-card" *ngFor="let product of userProducts">
     
        <img [src]="product.image || 'https://i.ibb.co/GvshXkLK/307ce493-b254-4b2d-8ba4-d12c080d6651.jpg'" [alt]="product.title" />
     
      <div class="product-info">
        <h3>{{ product.title }}</h3>
        <p class="product-category">{{ product.category }}</p>
        <p class="product-price">{{ product.price }} РѓЙ</p>
        <p class="product-year">рЃгрЃћрЃџрЃў: {{ product.year }}</p>
        <p class="product-location">{{ product.cities }}</p>
        <p class="product-date">рЃЊрЃљрЃЏрЃљрЃбрЃћрЃЉрЃБрЃџрЃўрЃљ: {{ formatDate(product.createdAt) }}</p>
      </div>
      <div class="product-actions">
        <button mat-flat-button class="delete-btn" (click)="deleteProduct(product._id!)">
          рЃгрЃљрЃерЃџрЃљ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Loading indicator -->
<div class="loading-overlay" *ngIf="isUploading">
  <div class="loading-spinner">
    <mat-progress-spinner diameter="50"></mat-progress-spinner>
    <p>рЃўрЃбрЃЋрЃўрЃарЃЌрЃћрЃЉрЃљ...</p>
  </div>
</div>